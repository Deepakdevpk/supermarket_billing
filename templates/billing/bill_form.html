{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h2>Create Bill</h2>
    <form method="post">
        {% csrf_token %}

        <div class="mb-3">
            <label><strong>Bill Number:</strong></label>
            <input type="text" class="form-control" value="{{ bill_number }}" readonly>
        </div>

        {{ bill_form.as_p }}

        <h4>Items</h4>
        <div id="formset-container">
            {{ formset.management_form }}
            {% for form in formset %}
                <div class="formset-row mb-3">
                    <div class="row">
                        {% for field in form.visible_fields %}
                            <div class="col-md-5 mb-2">{{ field.label_tag }} {{ field }}</div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <button type="button" id="add-form" class="btn btn-secondary mb-3">+ Add Product</button>

        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <button type="submit" name="action" value="check_customer" class="btn btn-primary">Proceed</button>

    </form>
</div>

<script>
    const addFormBtn = document.getElementById('add-form');
    const formsetContainer = document.getElementById('formset-container');
    let totalForms = document.getElementById('id_form-TOTAL_FORMS');

    addFormBtn.addEventListener('click', () => {
        const formCount = parseInt(totalForms.value);
        const newForm = formsetContainer.querySelector('.formset-row').cloneNode(true);
        const inputs = newForm.querySelectorAll('input, select');

        inputs.forEach((input) => {
            input.name = input.name.replace(/-(\d+)-/, `-${formCount}-`);
            input.id = input.id.replace(/-(\d+)-/, `-${formCount}-`);
            if (input.type !== 'hidden') input.value = '';
        });

        formsetContainer.appendChild(newForm);
        totalForms.value = formCount + 1;
    });
</script>
{% endblock %}
