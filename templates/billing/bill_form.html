{% extends 'base.html' %} {% block content %}
<div class="container">
  <h2>Create Bill</h2>
  <form method="post">
    {% csrf_token %}

    <div class="mb-3">
      <label><strong>Bill Number:</strong></label>
      <input
        type="text"
        class="form-control"
        value="{{ bill_number }}"
        readonly
      />
    </div>

    {{ bill_form.as_p }}

    <h4>Items</h4>
    <div id="formset-container">
      {{ formset.management_form }} {% for form in formset %}
      <div class="formset-row mb-3 border p-3 rounded">
        <div class="row">
          {% for field in form.visible_fields %}
          <div class="col-md-4 mb-2">{{ field.label_tag }} {{ field }}</div>
          {% endfor %}
          <div class="col-md-4 mb-2">
            <label><strong>Price:</strong></label>
            <input type="text" class="form-control price-field" readonly />
          </div>
          <div class="col-md-4 mb-2">
            <label><strong>Item Total:</strong></label>
            <input type="text" class="form-control item-total-field" readonly />
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <button type="button" id="add-form" class="btn btn-secondary mb-3">
      + Add Product
    </button>

    {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    <div class="mb-3">
      <label><strong>Total Amount:</strong></label>
      <input type="text" id="total-amount" class="form-control" readonly />
    </div>

    <button type="submit" class="btn btn-primary">processing</button>
  </form>
        <button type="submit" name="action" value="check_customer" class="btn btn-primary">Proceed</button>

    </form>
</div>

<script>
  const addFormBtn = document.getElementById("add-form");
  const formsetContainer = document.getElementById("formset-container");
  let totalForms = document.getElementById("id_form-TOTAL_FORMS");

  addFormBtn.addEventListener("click", () => {
    const formCount = parseInt(totalForms.value);
    const newForm = formsetContainer
      .querySelector(".formset-row")
      .cloneNode(true);
    const inputs = newForm.querySelectorAll("input, select");

    inputs.forEach((input) => {
      input.name = input.name.replace(/-(\d+)-/, `-${formCount}-`);
      input.id = input.id.replace(/-(\d+)-/, `-${formCount}-`);
      if (input.type !== "hidden") input.value = "";
    });

    formsetContainer.appendChild(newForm);
    totalForms.value = formCount + 1;
    attachPriceListeners();
  });

  function attachPriceListeners() {
    const productSelects = document.querySelectorAll("select");
    const quantityInputs = document.querySelectorAll('input[name$="quantity"]');

    productSelects.forEach((select, index) => {
      select.addEventListener("change", () => fetchProductPrice(select, index));
    });

    quantityInputs.forEach((input, index) => {
      input.addEventListener("input", () => calculateItemTotal(index));
    });
  }

  function fetchProductPrice(select, index) {
    const productId = select.value;
    if (productId) {
      fetch(`/inventory/get_price/${productId}/`)
        .then((response) => response.json())
        .then((data) => {
          document.querySelectorAll(".price-field")[index].value = data.price;
          calculateItemTotal(index);
        });
    }
  }

  function calculateItemTotal(index) {
    const quantity =
      parseFloat(
        document.querySelectorAll('input[name$="quantity"]')[index].value
      ) || 0;
    const price =
      parseFloat(document.querySelectorAll(".price-field")[index].value) || 0;
    const itemTotal = quantity * price;
    document.querySelectorAll(".item-total-field")[index].value =
      itemTotal.toFixed(2);
    updateBillTotal();
  }

  function updateBillTotal() {
    let total = 0;
    document.querySelectorAll(".item-total-field").forEach((input) => {
      total += parseFloat(input.value) || 0;
    });
    document.getElementById("total-amount").value = total.toFixed(2);
  }

  // Initialize listeners on first load
  window.onload = attachPriceListeners;
</script>
{% endblock %}
